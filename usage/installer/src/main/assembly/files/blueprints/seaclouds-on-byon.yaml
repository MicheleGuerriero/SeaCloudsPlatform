name: SeaClouds platform

location:
  byon:
    user: vagrant
    privateKeyFile: ../seaclouds-installer/byon/seaclouds_id_rsa
    hosts:
    - 192.168.100.10
    - 192.168.100.11

services:
- serviceType: brooklyn.entity.basic.SameServerEntity
  name: SeaClouds Deployer + Monitoring
  brooklyn.children:
  - serviceType: eu.seaclouds.modaclouds.dda.MODACloudsDeterministicDataAnalyzer
    name: MODAclouds Deterministic Data Analyzer
    id: monitoring-dda
  - serviceType: eu.seaclouds.modaclouds.manager.MODACloudsMonitoringManager
    name: MODAclouds Monitoring Manager
    id: monitoring-manager
    brooklyn.config:
      modaclouds.dda.ip: $brooklyn:component("monitoring-dda").attributeWhenReady("host.address")
  - serviceType: "classpath://brooklyn/entity/brooklynnode/brooklyn-node.yaml"
    id: deployer
    name: SeaClouds Deployer
    managementUser: admin
    managementPassword: p4ssw0rd
    brooklynLocalPropertiesContents: |
      brooklyn.webconsole.security.users=admin
      brooklyn.webconsole.security.user.admin.password=p4ssw0rd
    brooklyn.config:
      brooklynnode.download.archive.subpath: brooklyn-dist-0.7.0-incubating/
      brooklynnode.classpath:
        - classpath://deployer-0.8.0-SNAPSHOT.jar

- serviceType: brooklyn.entity.basic.SameServerEntity
  name: SeaClouds Dashboard + Planner + SLA

  shell.env:
    SLA_HOST: $brooklyn:component("sla-core").attributeWhenReady("host.address")
    SLA_PORT: $brooklyn:component("sla-core").attributeWhenReady("http.port")  
  
  brooklyn.children:
  - serviceType: eu.seaclouds.dashboard.SeacloudsDashboard
    name: SeaClouds Dashboard
    id: dashboard  
    brooklyn.config:
      port: 8000
      adminPort: 8001
      deployerHost: $brooklyn:component("deployer").attributeWhenReady("host.address")
      deployerPort: $brooklyn:component("deployer").attributeWhenReady("brooklynnode.webconsole.httpPort")
      deployerUser: $brooklyn:component("deployer").config("brooklynnode.managementUser")
      deployerPassword: $brooklyn:component("deployer").config("brooklynnode.managementPassword")
      slaHost: $SLA_HOST
      monitorHost: $brooklyn:component("monitoring-manager").attributeWhenReady("host.address")
      monitorPort: $brooklyn:component("monitoring-manager").attributeWhenReady("modaclouds.mm.port")      
    install.latch: $brooklyn:component("sla-core").attributeWhenReady("service.isUp")
    
  - serviceType: brooklyn.entity.webapp.tomcat.TomcatServer
    name: SLA service Core
    id: sla-core
    brooklyn.config:
      java.sysprops:
          DB_URL: $brooklyn:formatString("jdbc:%s%s", component("sla-db").attributeWhenReady("datastore.url"), "sc_sla")
          DB_USERNAME: "atossla"
          DB_PASSWORD: "_atossla_"
          MONITOR_METRICS_URL: $brooklyn:formatString("%s/v1/metrics", component("monitoring-manager").attributeWhenReady("main.uri"))
    war: https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=eu.seaclouds-project&a=sla-service&v=LATEST&e=war

  - serviceType: brooklyn.entity.database.mysql.MySqlNode
    id: sla-db
    name: SLA service Db
    brooklyn.config:
      creationScriptUrl: https://raw.githubusercontent.com/SeaCloudsEU/sla-core/e1d3bd4dec27236cfdefa1eae81d38db3dcd11da/sla-repository/src/main/resources/sql/01database.sql